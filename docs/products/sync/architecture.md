# 架构（Sync）

本页基于项目的流水线设计文档整理。

## 核心思想：流水线模式

把单个文件的处理拆成三个阶段，每个阶段都有独立队列与 Worker 池：

```
执行服务（定时）
  ↓ 发现新文件
下载队列 → 下载服务（N 个下载 Worker）→ 下载完成
  ↓ 路由（根据 enable_transcode 配置）
  ├─ 需要处理 → 处理队列 → 处理服务（M 个处理 Worker）→ 处理完成
  └─ 不需要处理 → 上传队列（跳过处理）
  ↓
上传队列 → 上传服务（K 个上传 Worker）→ 上传完成
```

## 三队列 + 四服务

- 队列：download / transcode(处理) / upload
- 服务：execute / download / transcode / upload

## 真实的“处理/转码”

设计文档里说明该阶段可能是：

- 追加少量随机字节以改变文件指纹/MD5

这与媒体重新编码不同：

- 不保证对所有客户端/播放器/校验机制完全兼容
- 可能影响校验、断点续传、预览等行为

建议：先对你的目标平台做兼容性验证。

## 可观测性

- 每个阶段是独立队列与 Worker，便于定位瓶颈。
- SSE 能提供更即时的进度反馈（但不替代日志与指标）。
